{% extends 'base.html' %}

{% block title %}Watch {{ movie.title }} - Mvs-Movie{% endblock %}

{% block extra_css %}
<style>
    .video-container {
        position: relative;
        width: 100%;
        max-width: 1400px;
        margin: 0 auto;
        background: rgba(26, 15, 15, 0.95);
        border-radius: 12px;
        overflow: hidden;
        border: 3px solid rgba(212, 175, 55, 0.4);
        box-shadow: 0 8px 32px rgba(212, 175, 55, 0.3);
    }

    .video-player {
        width: 100%;
        aspect-ratio: 16/9;
        background: #000;
    }

    .video-controls {
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        background: linear-gradient(to top, rgba(26, 15, 15, 0.95), transparent);
        padding: 20px;
        opacity: 0;
        transition: opacity 0.3s;
    }

    .video-container:hover .video-controls {
        opacity: 1;
    }

    .progress-bar {
        width: 100%;
        height: 6px;
        background: rgba(212, 175, 55, 0.2);
        border-radius: 3px;
        cursor: pointer;
        margin-bottom: 15px;
        position: relative;
        border: 1px solid rgba(212, 175, 55, 0.3);
    }

    .progress-filled {
        height: 100%;
        background: linear-gradient(90deg, #d4af37, #f4d03f);
        border-radius: 3px;
        transition: width 0.1s;
        box-shadow: 0 0 10px rgba(212, 175, 55, 0.5);
    }

    .progress-buffered {
        position: absolute;
        height: 100%;
        background: rgba(212, 175, 55, 0.3);
        border-radius: 3px;
    }

    .control-buttons {
        display: flex;
        align-items: center;
        gap: 15px;
    }

    .control-btn {
        background: rgba(139, 0, 0, 0.5);
        border: 1px solid rgba(212, 175, 55, 0.3);
        color: #d4af37;
        cursor: pointer;
        padding: 8px;
        border-radius: 6px;
        transition: all 0.3s;
    }

    .control-btn:hover {
        background: rgba(139, 0, 0, 0.8);
        border-color: #d4af37;
        box-shadow: 0 0 15px rgba(212, 175, 55, 0.4);
    }

    .volume-control {
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .volume-slider {
        width: 80px;
        accent-color: #d4af37;
    }

    .time-display {
        color: #d4af37;
        font-size: 14px;
        margin-left: auto;
        font-family: 'Crimson Text', serif;
        font-weight: 600;
    }

    .no-video-message {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        min-height: 400px;
        text-align: center;
        padding: 40px;
    }

    .limit-warning {
        background: linear-gradient(135deg, #f59e0b 0%, #ef4444 100%);
        color: #f5f5dc;
        padding: 12px 20px;
        border-radius: 8px;
        margin-bottom: 20px;
        text-align: center;
        font-weight: 600;
        font-family: 'Crimson Text', serif;
        border: 2px solid rgba(212, 175, 55, 0.3);
        box-shadow: 0 4px 15px rgba(239, 68, 68, 0.3);
    }
</style>
{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto">
    <!-- Back Button -->
    <div class="mb-6">
        <a href="{% url 'movies:movie_detail' movie.slug %}"
           class="inline-flex items-center text-amber-400 hover:text-amber-300 transition font-serif">
            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
            </svg>
            Back to Movie Details
        </a>
    </div>

    <!-- Watch Limit Warning -->
    {% if not has_subscription and remaining_seconds > 0 %}
    <div class="limit-warning" id="limitWarning" style="opacity: 0;">
        ⏱️ You have {{ remaining_minutes }} minutes remaining today. Subscribe for unlimited watching!
    </div>
    {% endif %}

    <!-- Video Player -->
    {% if has_video %}
    <div class="video-container mb-8">
        <video id="videoPlayer"
               class="video-player"
               {% if movie.video_file %}
               src="{% url 'player:stream' movie.slug %}"
               {% elif movie.video_url %}
               src="{{ movie.video_url }}"
               {% endif %}
               preload="metadata">
            Your browser does not support the video tag.
        </video>

        <!-- Custom Controls -->
        <div class="video-controls" id="videoControls">
            <!-- Progress Bar -->
            <div class="progress-bar" id="progressBar">
                <div class="progress-buffered" id="progressBuffered" style="width: 0%"></div>
                <div class="progress-filled" id="progressFilled" style="width: 0%"></div>
            </div>

            <!-- Control Buttons -->
            <div class="control-buttons">
                <!-- Play/Pause -->
                <button class="control-btn" id="playPauseBtn" title="Play">
                    <svg class="w-8 h-8" fill="currentColor" viewBox="0 0 20 20" id="playIcon">
                        <path d="M6.3 2.841A1.5 1.5 0 004 4.11V15.89a1.5 1.5 0 002.3 1.269l9.344-5.89a1.5 1.5 0 000-2.538L6.3 2.84z"/>
                    </svg>
                    <svg class="w-8 h-8 hidden" fill="currentColor" viewBox="0 0 20 20" id="pauseIcon">
                        <path d="M5 4a2 2 0 012-2h2a2 2 0 012 2v12a2 2 0 01-2 2H7a2 2 0 01-2-2V4zm8 0a2 2 0 012-2h2a2 2 0 012 2v12a2 2 0 01-2 2h-2a2 2 0 01-2-2V4z"/>
                    </svg>
                </button>

                <!-- Volume -->
                <div class="volume-control">
                    <button class="control-btn" id="muteBtn" title="Mute">
                        <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20" id="volumeIcon">
                            <path d="M9.383 3.076A1 1 0 0110 4v12a1 1 0 01-1.707.707L4.586 13H2a1 1 0 01-1-1V8a1 1 0 011-1h2.586l3.707-3.707a1 1 0 011.09-.217zM14.657 2.929a1 1 0 011.414 0A9.972 9.972 0 0119 10a9.972 9.972 0 01-2.929 7.071 1 1 0 01-1.414-1.414A7.971 7.971 0 0017 10c0-2.21-.894-4.208-2.343-5.657a1 1 0 010-1.414zm-2.829 2.828a1 1 0 011.415 0A5.983 5.983 0 0115 10a5.984 5.984 0 01-1.757 4.243 1 1 0 01-1.415-1.415A3.984 3.984 0 0013 10a3.983 3.983 0 00-1.172-2.828 1 1 0 010-1.415z"/>
                        </svg>
                        <svg class="w-6 h-6 hidden" fill="currentColor" viewBox="0 0 20 20" id="mutedIcon">
                            <path d="M9.383 3.076A1 1 0 0110 4v12a1 1 0 01-1.707.707L4.586 13H2a1 1 0 01-1-1V8a1 1 0 011-1h2.586l3.707-3.707a1 1 0 011.09-.217zM12.293 7.293a1 1 0 011.414 0L15 8.586l1.293-1.293a1 1 0 111.414 1.414L16.414 10l1.293 1.293a1 1 0 01-1.414 1.414L15 11.414l-1.293 1.293a1 1 0 01-1.414-1.414L13.586 10l-1.293-1.293a1 1 0 010-1.414z"/>
                        </svg>
                    </button>
                    <input type="range"
                           class="volume-slider"
                           id="volumeSlider"
                           min="0"
                           max="100"
                           value="100">
                </div>

                <!-- Time Display -->
                <div class="time-display" id="timeDisplay">
                    <span id="currentTime">0:00</span> / <span id="duration">0:00</span>
                </div>

                <!-- Fullscreen -->
                <button class="control-btn ml-auto" id="fullscreenBtn" title="Fullscreen">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4"></path>
                    </svg>
                </button>
            </div>
        </div>
    </div>

    <!-- Movie Info -->
    <div class="vintage-card rounded-lg border border-amber-900/30 p-6 shadow-xl">
        <div class="flex items-start justify-between">
            <div>
                <h1 class="ornate-title text-3xl mb-2">{{ movie.title }}</h1>
                <p class="text-amber-200/70 font-serif">
                    {{ movie.year }} • {{ movie.category.name }} • {{ movie.get_duration_display }}
                </p>
            </div>
            <a href="{% url 'movies:movie_detail' movie.slug %}" class="vintage-btn py-2 px-6">
                More Info
            </a>
        </div>
    </div>

    {% else %}
    <!-- No Video Available -->
    <div class="video-container">
        <div class="no-video-message">
            <svg class="w-20 h-20 text-amber-400/50 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
            </svg>
            <h2 class="ornate-title text-2xl mb-2">No Video Available</h2>
            <p class="text-amber-200/70 font-serif mb-6">
                This movie doesn't have a video file uploaded yet.
            </p>
            <a href="{% url 'movies:movie_detail' movie.slug %}" class="vintage-btn py-3 px-6">
                Back to Movie Details
            </a>
        </div>
    </div>
    {% endif %}
</div>

{% if has_video %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const video = document.getElementById('videoPlayer');
    const playPauseBtn = document.getElementById('playPauseBtn');
    const playIcon = document.getElementById('playIcon');
    const pauseIcon = document.getElementById('pauseIcon');
    const muteBtn = document.getElementById('muteBtn');
    const volumeIcon = document.getElementById('volumeIcon');
    const mutedIcon = document.getElementById('mutedIcon');
    const volumeSlider = document.getElementById('volumeSlider');
    const progressBar = document.getElementById('progressBar');
    const progressFilled = document.getElementById('progressFilled');
    const progressBuffered = document.getElementById('progressBuffered');
    const currentTimeEl = document.getElementById('currentTime');
    const durationEl = document.getElementById('duration');
    const fullscreenBtn = document.getElementById('fullscreenBtn');
    const videoContainer = document.querySelector('.video-container');
    const limitWarning = document.getElementById('limitWarning');

    let progressSaveTimeout;
    let lastSaveTime = 0;
    let watchStartTime = Date.now();
    const movieId = {{ movie.id }};
    const savedProgress = {{ watch_history.progress|default:0 }};
    const hasSubscription = {{ has_subscription|yesno:"true,false" }};
    let remainingSeconds = {{ remaining_seconds }};

    function formatTime(seconds) {
        const mins = Math.floor(seconds / 60);
        const secs = Math.floor(seconds % 60);
        return `${mins}:${secs.toString().padStart(2, '0')}`;
    }

    playPauseBtn.addEventListener('click', function() {
        if (video.paused) {
            if (!hasSubscription && remainingSeconds <= 0) {
                alert('Daily watch limit reached. Subscribe to watch unlimited!');
                return;
            }
            video.play();
            playIcon.classList.add('hidden');
            pauseIcon.classList.remove('hidden');
            watchStartTime = Date.now();
        } else {
            video.pause();
            playIcon.classList.remove('hidden');
            pauseIcon.classList.add('hidden');
        }
    });

    video.addEventListener('click', function() {
        playPauseBtn.click();
    });

    muteBtn.addEventListener('click', function() {
        video.muted = !video.muted;
        if (video.muted) {
            volumeIcon.classList.add('hidden');
            mutedIcon.classList.remove('hidden');
        } else {
            volumeIcon.classList.remove('hidden');
            mutedIcon.classList.add('hidden');
        }
    });

    volumeSlider.addEventListener('input', function() {
        video.volume = this.value / 100;
        if (video.volume === 0) {
            video.muted = true;
            volumeIcon.classList.add('hidden');
            mutedIcon.classList.remove('hidden');
        } else {
            video.muted = false;
            volumeIcon.classList.remove('hidden');
            mutedIcon.classList.add('hidden');
        }
    });

    video.addEventListener('timeupdate', function() {
        const percent = (video.currentTime / video.duration) * 100;
        progressFilled.style.width = percent + '%';
        currentTimeEl.textContent = formatTime(video.currentTime);

        // Check limit for non-subscribers
        if (!hasSubscription && remainingSeconds > 0) {
            const elapsed = Math.floor((Date.now() - watchStartTime) / 1000);
            const newRemaining = remainingSeconds - elapsed;

            if (newRemaining <= 0) {
                video.pause();
                alert('Daily watch limit reached! Subscribe for unlimited watching.');
                window.location.href = '{% url "movies:movie_detail" movie.slug %}';
                return;
            }

            if (limitWarning && newRemaining <= 300) { // 5 minutes warning
                limitWarning.textContent = `⏱️ ${Math.floor(newRemaining / 60)} minutes remaining today!`;
                limitWarning.style.background = 'linear-gradient(135deg, #ef4444 0%, #dc2626 100%)';
            }
        }

        if (progressSaveTimeout) {
            clearTimeout(progressSaveTimeout);
        }
        progressSaveTimeout = setTimeout(() => {
            saveProgress();
        }, 10000);
    });

    video.addEventListener('loadedmetadata', function() {
        durationEl.textContent = formatTime(video.duration);

        if (savedProgress > 0 && savedProgress < video.duration - 30) {
            const resume = confirm(`Continue from ${formatTime(savedProgress)}?`);
            if (resume) {
                video.currentTime = savedProgress;
            }
        }
    });

    video.addEventListener('progress', function() {
        if (video.buffered.length > 0) {
            const bufferedEnd = video.buffered.end(video.buffered.length - 1);
            const percent = (bufferedEnd / video.duration) * 100;
            progressBuffered.style.width = percent + '%';
        }
    });

    progressBar.addEventListener('click', function(e) {
        const rect = progressBar.getBoundingClientRect();
        const percent = (e.clientX - rect.left) / rect.width;
        video.currentTime = percent * video.duration;
    });

    fullscreenBtn.addEventListener('click', function() {
        if (!document.fullscreenElement) {
            videoContainer.requestFullscreen();
        } else {
            document.exitFullscreen();
        }
    });

    document.addEventListener('keydown', function(e) {
        switch(e.key) {
            case ' ':
                e.preventDefault();
                playPauseBtn.click();
                break;
            case 'f':
            case 'F':
                fullscreenBtn.click();
                break;
            case 'm':
            case 'M':
                muteBtn.click();
                break;
            case 'ArrowLeft':
                video.currentTime -= 10;
                break;
            case 'ArrowRight':
                video.currentTime += 10;
                break;
            case 'ArrowUp':
                e.preventDefault();
                video.volume = Math.min(1, video.volume + 0.1);
                volumeSlider.value = video.volume * 100;
                break;
            case 'ArrowDown':
                e.preventDefault();
                video.volume = Math.max(0, video.volume - 0.1);
                volumeSlider.value = video.volume * 100;
                break;
        }
    });

    function saveProgress() {
        const currentTime = video.currentTime;
        const watchTime = Math.floor((Date.now() - watchStartTime) / 1000);
        watchStartTime = Date.now();

        fetch('{% url "player:save_progress" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({
                movie_id: movieId,
                progress: Math.floor(currentTime),
                duration: Math.floor(video.duration),
                watch_time: watchTime
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success && !hasSubscription) {
                remainingSeconds = data.remaining_seconds;
            }
        });
    }

    window.addEventListener('beforeunload', function() {
        if (!video.paused) {
            saveProgress();
        }
    });

    video.addEventListener('ended', function() {
        saveProgress();
    });
});
</script>
{% endif %}
{% endblock %}